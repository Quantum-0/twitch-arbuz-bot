{% extends "base.html" %}

{% block title %}Настройки — Quantum0's Bot{% endblock %}

{% block styles %}
{{ super() }}
.toggle-label { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; font-size: 16px; }
.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    background-color: #ccc;
    border-radius: 26px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.toggle-switch::after {
    content: "";
    position: absolute;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.3s;
}
.toggle-switch.active { background-color: #4CAF50; }
.toggle-switch.active::after { transform: translateX(24px); }
button {
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: block;
    margin: 20px auto;
    transition: background-color 0.3s;
}
button:hover { background-color: #45a049; }
button.btn-danger { background-color: #e53935; }
button.btn-danger:hover { background-color: #d32f2f; }
.notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
.notification {
    padding: 0;
    margin-top: 10px;
    border-radius: 5px;
    background: #fff;
    border: 2px solid #4CAF50;
    color: #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp var(--notif-in-duration) forwards;
    overflow: hidden;
}
.notification.error { border-color: #e53935; }
.notification-header { background: #d9f2d9; padding: 5px 10px; font-weight: bold; font-size: 14px; }
.notification-body { padding: 10px; font-size: 14px; }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
@keyframes fadeOutDown { to { opacity: 0; transform: translateY(10px); } }
/* Модальное окно */
.modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 320px;
    width: 90%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.modal-content input {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}
.modal-content button { margin-top: 10px; width: 100%; }
.memealert-coins { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
.memealert-coins input { width: 80px; text-align: center; }
{% endblock %}

{% block content %}
<h2>Привет, {{ user.login_name }}!</h2>
<p>Настройте функции вашего бота:</p>

<hr>

<section>
    <h3>Настройки чат-бота</h3>
    <div class="toggle-label">
        <span>Включить !help</span>
        <div class="toggle-switch {% if settings.enable_help %}active{% endif %}" data-name="enable_help"></div>
    </div>
    <div class="toggle-label">
        <span>Включить !random</span>
        <div class="toggle-switch {% if settings.enable_random %}active{% endif %}" data-name="enable_random"></div>
    </div>
    <div class="toggle-label">
        <span>Включить !fruit</span>
        <div class="toggle-switch {% if settings.enable_fruit %}active{% endif %}" data-name="enable_fruit"></div>
    </div>
</section>

<hr>

<section>
    <h3>Настройки мемалёртов</h3>
    {% if memealerts.enabled %}
        <button id="memealerts-btn" class="btn-danger" onclick="toggleMemealerts(false)">Отключить мемалёрты</button>
        <p>Время жизни токена: {{ memealerts.expires_in }} дней.</p>
        <div class="memealert-coins">
            <label for="coin-count">Мемкоины:</label>
            <input type="number" id="coin-count" min="1" max="100" value="{{ memealerts.coin_count or 1 }}">
            <button id="update-coins-btn" onclick="updateCoins()">Сохранить</button>
        </div>
    {% else %}
        <button id="memealerts-btn" onclick="openModal()">Включить мемалёрты</button>
    {% endif %}
</section>

<div class="notification-container"></div>

<!-- Модальное окно -->
<div class="modal" id="memealert-modal">
    <div class="modal-content">
        <h3>Введите ключ</h3>
        <input type="text" id="memealert-key" placeholder="Ваш ключ">
        <button onclick="saveMemealert()">Сохранить</button>
        <button onclick="closeModal()">Отмена</button>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    function showNotification(title, message, isError=false) {
        const container = document.querySelector('.notification-container');
        const div = document.createElement('div');
        div.className = 'notification' + (isError ? ' error' : '');
        div.innerHTML = `<div class="notification-header">${title}</div><div class="notification-body">${message}</div>`;
        container.appendChild(div);
        setTimeout(() => {
            div.style.animation = 'fadeOutDown var(--notif-out-duration) forwards';
            setTimeout(() => div.remove(), 250);
        }, 4000);
    }

    function toggleSetting(name, enabled) {
        fetch('/api/user/update_settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `${name}=${enabled ? 'true' : 'false'}`
        })
        .then(res => res.json().then(data => ({ ok: res.ok, data })))
        .then(({ok, data}) => showNotification(data.title || 'Настройки', data.message, !ok))
        .catch(err => showNotification('Ошибка', err.message, true));
    }

    function initToggles() {
        document.querySelectorAll('.toggle-switch').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                toggleSetting(toggle.dataset.name, toggle.classList.contains('active'));
            });
        });
    }

    function openModal() { document.getElementById('memealert-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('memealert-modal').style.display = 'none'; }

    function saveMemealert() {
        const key = document.getElementById('memealert-key').value.trim();
        if (!key) return showNotification('Ошибка', 'Введите ключ', true);
        closeModal();
        toggleMemealerts(true, key);
    }

    function toggleMemealerts(enable, key='') {
        const btn = document.getElementById('memealerts-btn');
        btn.disabled = true;
        btn.textContent = 'Подождите...';
        fetch(`/api/user/memealerts?enable=${enable}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: enable ? `key=${encodeURIComponent(key)}` : ''
        })
        .then(res => res.json().then(data => ({ ok: res.ok, data })))
        .then(({ok, data}) => {
            showNotification(data.title || 'Мемалёрты', data.message, !ok);
            setTimeout(() => location.reload(), 2000);
        })
        .catch(err => {
            showNotification('Ошибка', err.message, true);
            btn.disabled = false;
            btn.textContent = enable ? 'Включить мемалёрты' : 'Отключить мемалёрты';
        });
    }

    function updateCoins() {
        const btn = document.getElementById('update-coins-btn');
        const count = document.getElementById('coin-count').value;
        if (count < 1 || count > 100) return showNotification('Ошибка', 'Введите число от 1 до 100', true);
        btn.disabled = true;
        btn.textContent = 'Сохраняю...';
        fetch('/api/user/memealerts/coins', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ count: count })
        })
        .then(res => res.json().then(data => ({ ok: res.ok, data })))
        .then(({ok, data}) => {
            showNotification(data.title || 'Мемкоины', data.message, !ok);
            btn.textContent = 'Сохранено!';
            setTimeout(() => { btn.disabled = false; btn.textContent = 'Сохранить'; }, 1000);
        })
        .catch(err => {
            showNotification('Ошибка', err.message, true);
            btn.disabled = false;
            btn.textContent = 'Сохранить';
        });
    }

    document.addEventListener('DOMContentLoaded', initToggles);
</script>
{% endblock %}
