<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SSE PNG Overlay</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
        }

        .sprite {
            position: absolute;
            width: 256px;
            height: 256px;
            pointer-events: none;
            opacity: 0;
            will-change: transform, left, top, opacity;
        }

        .sprite.spawn {
            animation: sticker-pop 350ms cubic-bezier(.34,1.56,.64,1) forwards;
        }

        .fade-out {
            opacity: 0;
            transition: opacity 2s linear;
        }

        @keyframes sticker-pop {
            0% {
                transform: scale(0) rotate(var(--rotation));
                opacity: 0;
            }
            60% {
                transform: scale(1.25) rotate(calc(var(--rotation) + 9deg));
                opacity: 1;
            }
            80% {
                transform: scale(0.90) rotate(calc(var(--rotation) - 5deg));
            }
            100% {
                transform: scale(1) rotate(var(--rotation));
                opacity: 1;
            }
        }

    </style>
</head>
<body>

<audio id="sticker-sound" preload="auto">
    <source src="/static/sounds/sticker-pop.wav" type="audio/mpeg">
</audio>


<script>
    const SSE_URL = "{{ request.base_url }}sse/{{ channel_id }}/ai-sticker";

    const LIFE_TIME_MS = 60_000;
    const FADE_OUT_MS = 2_000;

    let zIndexCounter = 1;

    const eventSource = new EventSource(SSE_URL);

    eventSource.onmessage = (event) => {
        try {
            let base64;

            if (event.data.startsWith("{")) {
                base64 = JSON.parse(event.data).image;
            } else {
                base64 = event.data;
            }

            spawnImage(base64);
        } catch (e) {
            console.error("SSE parse error:", e);
        }
    };

    eventSource.onerror = (e) => {
        console.error("SSE error:", e);
    };

    function spawnImage(base64) {
        const img = document.createElement("img");
        img.className = "sprite";
        img.src = `data:image/png;base64,${base64}`;
        img.style.zIndex = zIndexCounter++;

        const maxX = window.innerWidth - 256;
        const maxY = window.innerHeight - 256;

        const x = Math.random() * maxX;
        const y = Math.random() * maxY;
        const rotation = random(-45, 45);

        img.style.left = `${x}px`;
        img.style.top = `${y}px`;
        img.style.setProperty("--rotation", `${rotation}deg`);

        document.body.appendChild(img);

        // Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸
        requestAnimationFrame(() => {
            img.classList.add("spawn");
        });

        // ðŸ”Š Ð·Ð²ÑƒÐº
        const sound = document.getElementById("sticker-sound");
        if (sound) {
            sound.currentTime = 0;
            sound.play().catch(() => {});
        }

        // fade-out
        setTimeout(() => {
            img.classList.add("fade-out");
        }, LIFE_TIME_MS - FADE_OUT_MS);

        // Ð¿Ð¾Ð»Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
        setTimeout(() => {
            img.remove();
        }, LIFE_TIME_MS);
    }

    function random(min, max) {
        return Math.random() * (max - min) + min;
    }
</script>

</body>
</html>