import random
from typing import Any

from database.models import TwitchUserSettings, User
from twitch.chat.base.saving_result_command import SavingResultCommand
from twitch.utils import join_targets


class HornyGoodCommand(SavingResultCommand):
    command_name = "horny_good"
    command_aliases = ["horny", "—Ö–æ—Ä–Ω–∏"]
    command_description = "–£–∑–Ω–∞—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ç–æ—Ç —Å—Ç—Ä–∏–º ;)"

    cooldown_timer = 10

    refresh_result_timer = 3 * 60

    def is_enabled(self, streamer_settings: TwitchUserSettings) -> bool:
        return streamer_settings.enable_horny_good

    async def result_generator(self, old_value: str | None, **kwargs: Any) -> str:
        if old_value is None:
            return str(random.randint(0, 100))
        if old_value[0] in ["+", "-"]:
            old_value = int(old_value[1:])
        else:
            old_value = int(old_value)
        new_value = random.randint(0, 100)
        if new_value == old_value:
            return str(new_value)
        if new_value > old_value:
            return f"+{new_value}"
        return f"-{new_value}"

    async def _cooldown_reply(self, user: str, delay: int) -> str | None:
        return random.choice(
            [
                f"–°–æ–ª–Ω—ã—à–∫–æ, –ø–∏—Ä–æ–∂–æ—á–µ–∫ —Ç—ã –Ω–∞—à –Ω–µ–ø—Ä–∏–ª–∏—á–Ω—ã–π, –º—ã –∂–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–º–æ—Ç—Ä–µ–ª–∏ –Ω–∞ —Ç–≤–æ—ë —Ö–æ—Ä–Ω–∏ –ü–æ—Ç–µ—Ä–ø–∏ —á—É—Ç—å-—á—É—Ç—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–º–µ–Ω—è–µ—Ç—Å—è ;)"
            ]
        )

    async def _handle_new(self, streamer: User, user: str, text: str, new_value: str):
        change = new_value[0] if new_value[0] in ["+", "-"] else None
        value = int(new_value[1:]) if new_value[0] in ["+", "-"] else int(new_value)

        if value < 20:
            if random.random() < 0.5:
                result = f"@{user} —Ö–æ—Ä–Ω–∏ –≤—Å–µ–≥–æ-–ª–∏—à—å –Ω–∞ {value}%. –ú–∞–ª–æ–≤–∞—Ç–æ –±—É–¥–µ—Ç, —á—Ç–æ –∂ —Ç—ã —Ç–∞–∫? –†–∞—Å—Å–∫–∞–∂–∏ –Ω–∞–º –æ —Å–≤–æ–∏—Ö –≤–∫—É—Å–∞—Ö, –∞ –º—ã —Å —á–∞—Ç–∏–∫–æ–º –ø–æ–¥—É–º–∞–µ–º, –∫–∞–∫ –º–æ–∂–µ–º –ø–æ–º–æ—á—å —Ç–µ–±–µ :–∑"
            else:
                result = f"@{user} —Ö–æ—Ä–Ω–∏ –≤—Å–µ–≥–æ –Ω–∞ {value}%. üò± –ù–∞ –º–æ—ë–º —Å—Ç—Ä–∏–º–µ? –ò —Å—Ç–æ–ª—å –Ω–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç?! –ß—Ç–æ —Ç—ã —Å–∫–∞–∂–µ—à—å –≤ —Å–≤–æ—ë –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–µ?!"
                if change == "+":
                    result += random.choice(
                        [
                            " –ù—É —Ö–æ—Ç—å —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞ –ø–æ–±–æ–ª—å—à–µ —Å—Ç–∞–ª–æ..",
                            " –ù—É —Ö–æ—Ç—å —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞ –≤—ã—Ä–æ—Å–ª–æ..",
                        ]
                    )
                elif change == "-":
                    result += random.choice(
                        [" –í –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –ø–æ–±–æ–æ–æ–ª—å—à–µ –±—ã–ª–æ –∫–æ–Ω–µ—á–Ω–æ.."]
                    )
        elif value < 40:
            if random.random() < 0.5:
                if change == "+":
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}% –∏ –±–æ–ª–µ–µ —Ç–æ–≥–æ, —è –≤–∏–∂—É –∫–∞–∫ —Å—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Ç—ë—Ç —Ç–≤–æ–π... –ø—Ä–æ—Ü–µ–Ω—Ç! >:–∑"
                elif change == "-":
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%, –∏ —è –≤–∏–∂—É –∫–∞–∫ —Ç–≤–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–∞–¥–∞–µ—Ç üò± –ù–∞–¥–µ—é—Å—å, —á—Ç–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ, –∏ –≤ –±–ª–∏–∂–∞–π—à–µ–º –±—É–¥—É—â–µ–º —Ç—ã –ø–æ–¥–Ω–∏–º–µ—à—å —Å–≤–æ–π... –ø—Ä–æ—Ü–µ–Ω—Ç! >:–∑"
                else:
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}% –∏ —è —É–ø–æ–≤–∞—é –Ω–∞ —Ç–æ, —á—Ç–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ, –∏ –≤ –±–ª–∏–∂–∞–π—à–µ–º –±—É–¥—É—â–µ–º —Ç—ã –ø–æ–¥–Ω–∏–º–µ—à—å —Å–≤–æ–π... –ø—Ä–æ—Ü–µ–Ω—Ç! >:–∑"
            else:
                if change == "+":
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%. –Ø –≤–∏–∂—É —Ç–≤–æ–∏ —Å–æ–º–Ω–µ–Ω–∏—è, –Ω–æ, –∫–∞–∂–µ—Ç—Å—è, —Ç—ã –¥–≤–∏–≥–∞–µ—à—å—Å—è –≤ –Ω—É–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É >w>"
                else:
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%. –Ø –≤–∏–∂—É —Ç–≤–æ–∏ —Å–æ–º–Ω–µ–Ω–∏—è, –Ω–æ, –Ω–∞–¥–µ—é—Å—å, –≤ –∏—Ç–æ–≥–µ —Ç—ã –≤—ã–±–µ—Ä–µ—à—å —Ç—ë–º–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É >w>"
        elif value < 60:
            if random.random() < 0.5:
                if change == "+":
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%. –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞! –ê —Ç–æ—Ç —Ñ–∞–∫—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ—Å–ª–æ —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞ - –Ω–µ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–¥–æ–≤–∞—Ç—å!"
                else:
                    result = (
                        f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%. –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞, –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ!"
                    )
            else:
                result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%. –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ, –¥—É–º–∞—é, –Ω–∞–º –≤—Å–µ–º —Å—Ç–æ–∏—Ç –ø–æ—Å—Ç–∞—Ä–∞—Ç—å—Å—è –∏ –ø–æ–º–æ—á—å @{user} –ø–æ–¥–Ω—è—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ –º–∞–∫—Å–∏–º—É–º–∞!"
        elif value < 80:
            if random.random() < 0.5:
                result = f"–í —á–∞—Ç–∏–∫–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∂–∞—Ä–∫–æ? –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–∫–∏–Ω–µ–º –¥—Ä–æ–≤ –∏ —Ä–∞–∑–≥–æ—Ä–∏–º –æ–≥–æ–Ω—å —Å–∏–ª—å–Ω–µ–µ, –≤–µ–¥—å @{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%"
                if change == "+":
                    result = f"@{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%. –¢–≤–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ç–∞–∫–æ–π.. –±–æ–ª—å—à–æ–π! –ò —Å –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç–æ–π –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å—ë –±–æ–ª—å—à–µ –∏ –±–æ–ª—å—à–µ! –û—Ö—Ö~ –°—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∂–∞—Ä–∫–æ~"
            else:
                result = f"–°–ø—Ä—è—á—å—Ç–µ –≤–µ—Å—å Anti-Horny Spray‚Ñ¢! –ú—ã –≤–µ–¥—å –Ω–µ —Ö–æ—Ç–∏–º –ª–∏—à–∏—Ç—å—Å—è —Ä–∞–∑–≥–æ—Ä–∞—é—â–∏—Ö—Å—è —Å—Ç—Ä–∞—Å—Ç–µ–π –≤ —á–∞—Ç–µ, –∏–±–æ —É @{user} –∞–∂ —Ü–µ–ª—ã—Ö {value}%"
        elif value < 95:
            if random.random() < 0.5:
                result = f"–ì–ª—è–∂—É, –ø–æ–¥ —Ç–æ–±–æ–π —É–∂–µ –º–æ–∫—Ä–æ, –≤–µ–¥—å —É —Ç–µ–±—è, @{user} - {value}%! –¢–æ–ª—å–∫–æ –Ω–µ –∑–∞—Ç–æ–ø–∏ —á–∞—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ ;)"
                if random.random() < 0.25:
                    result += " –•–æ—Ç—è –∫—Ç–æ –∑–Ω–∞–µ—Ç, –º–æ–∂–µ—Ç –æ–Ω–∏ –∏ –Ω–µ –ø—Ä–æ—Ç–∏–≤ ;)"
            else:
                result = f"–ß–∞—Ç! –ì–æ—Ç–æ–≤—å—Ç–µ—Å—å! –£ @{user} - {value}%, –¥–µ—Ä–∂–∏—Ç–µ —Å–≤–æ–∏ —Ç—Ä—É—Å—ã, –∞ —Ç–æ —É—Ç–∞—â–∏—Ç!"
                # "–í–æ—Ç $randomfollowerusername —É–∂–µ –±–µ–∑ —Ç—Ä—É—Å–æ–≤, –∫—Ç–æ –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π –∂–µ—Ä—Ç–≤–æ–π?"
        else:  # 95-100
            if random.random() < 0.5:
                result = f"–°–æ—Å–µ–¥–∏ —Å–Ω–∏–∑—É —Å—Ç—É—á–∞—Ç—Å—è –≤ –¥–≤–µ—Ä—å –∏ —Ä—É–≥–∞—é—Ç—Å—è, —á—Ç–æ –∏—Ö –∑–∞—Ç–æ–ø–∏–ª–∏. –ê –≤—Å—ë –ø–æ—Ç–æ–º—É —á—Ç–æ @{user} —Ö–æ—Ä–Ω–∏ –Ω–∞ {value}%!"
            else:
                result = f"–£ @{user} - {value}%, –∫—Ç–æ –∂–µ —Å—Ç–∞–Ω–µ—Ç –ø–µ—Ä–≤–æ–π –∂–µ—Ä—Ç–≤–æ–π? –°—Ç–∞–≤—å—Ç–µ ¬´+¬ª –≤ —á–∞—Ç, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ø–∞—Å—Ç—å –ø–æ–¥ —Ä–∞–∑–¥–∞—á—É!"
        return result

    async def _target_selected(self, user: str, targets: list[str]):
        variants = [
            f"{user} –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–µ–≥–æ —Ö–æ—Ä–Ω–∏, –ø–æ—ç—Ç–æ–º—É —Ç—Ä–æ–≥–∞–µ—Ç —á—É–∂–æ–µ √íw√ì",
            f"{user} –ø–æ—Å—ã–ª–∞–µ—Ç —Å–≤–æ–∏ —Ö–æ—Ä–Ω–∏-–≤–∞–π–±—ã –≤ {join_targets(targets)}",
            f"{user} —Ö–æ—á–µ—Ç –∑–∞—Ö–æ—Ä–Ω—è–≤–∏—Ç—å {join_targets(targets)} :>",
        ]
        return random.choice(variants)

    async def _handle_old(
        self, streamer: User, user: str, text: str, old_value: str, seconds_spend: str
    ):
        value = old_value[1:] if old_value[0] in ["+", "-"] else old_value
        variants = [
            f"–ú—ã —É–∂–µ —É–∑–Ω–∞–ª–∏, —á—Ç–æ —Ç—ã –Ω–∞ {value}% —Ö–æ—Ä–Ω–∏. –ù–∞–±–µ—Ä–∏—Å—å —Ç–µ—Ä–ø–µ–Ω–∏—è, –º—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ç–≤–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤–æ–∑—Ä–∞—Å—Ç—ë—Ç :>",
            f"@{user} –Ω–µ —Ç–µ—Ä–ø–∏—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ—é —Ö–æ—Ä–Ω—è–≤–Ω–æ—Å—Ç—å, –≤ –Ω–∞–¥–µ–∂–¥–µ, —á—Ç–æ –æ–Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç—ë—Ç, –Ω–æ –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å :>",
        ]
        return random.choice(variants)
